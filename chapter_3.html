<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Version-0 : Matrix Connect - Writing a Matrix Bridge in Rust</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="preface.html">Preface</a></li><li class="chapter-item expanded affix "><a href="author.html">About Author</a></li><li class="chapter-item expanded affix "><a href="intro.html">Introduction</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="chapter_1.html">Community Bonding Period</a></li><li class="chapter-item expanded affix "><a href="chapter_2.html">Creating Concept for Project</a></li><li class="chapter-item expanded affix "><a href="chapter_3.html" class="active">Version-0 : Matrix Connect</a></li><li class="chapter-item expanded affix "><a href="chapter_4.html">Version-0+ : Concrete Plan</a></li><li class="chapter-item expanded affix "><a href="chapter_5.html">Version-1 : The real bridge</a></li><li class="chapter-item expanded affix "><a href="chapter_6.html">Version-1 : Configuring bridge</a></li><li class="chapter-item expanded affix "><a href="chatper_7.html">Version-2 : Group/Room Creation</a></li><li class="chapter-item expanded affix "><a href="chatper_8.html">Version-2 : DM from qaul to matrix</a></li><li class="chapter-item expanded affix "><a href="chapter_9.html">Version-2 : Invite/Remove from group</a></li><li class="chapter-item expanded affix "><a href="chapter_10.html">Version-2 : Sending/Receiving files</a></li><li class="chapter-item expanded affix "><a href="chapter_11.html">Version-2 : Polishing with user menu</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="chapter_12.html">Chaos Communication Camp</a></li><li class="chapter-item expanded affix "><a href="chapter_13.html">GSoC Lightening Talks 2023</a></li><li class="chapter-item expanded affix "><a href="chapter_14.html">Matrix Summit 2023</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><a href="chapter16.html">Project Resources</a></li><li class="chapter-item expanded affix "><a href="chapter_15.html">Closing Notes</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Writing a Matrix Bridge in Rust</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="coding-version-0-and-challenges-faced"><a class="header" href="#coding-version-0-and-challenges-faced">Coding Version 0 and Challenges Faced</a></h1>
<h2 id="kickstarting-coding"><a class="header" href="#kickstarting-coding">Kickstarting coding</a></h2>
<p>The very first step in developing the Matrix bridge for qaul was to attempt and create a login functionality into the matrix from the qaul code. As mentioned earlier, By reffering the <code>examples/</code> in <code>matrix-sdk</code> which was latest at <code>0.6.2</code> by the time I am writing this, I wrote a new file inside qaul-matrix-bridge binary called <code>relay_bot.rs</code> along with a <code>connect()</code> method which will allow us to connect with matrix.</p>
<h2 id="dependencies-conflicts"><a class="header" href="#dependencies-conflicts">Dependencies conflicts</a></h2>
<p>With the new <code>connect()</code> method and the <code>relay_bot.rs</code> code, compiler complaint heavily with list of errors. On debugging, The errors were about dependency version conflict.</p>
<p>With latest <code>matrix-sdk 0.6.2</code>, Version mismatched for <code>libp2p</code> which at the time has latest <code>0.51.x</code> and qaul was using <code>0.50.0</code> and <code>0.52.0</code> was about to release officially within next upcoming month. The code was compiling if we downgrade <code>matrix-sdk</code> to <code>0.4.0</code>. But then we lose some methods which connects qaul directly with some abstraction level to matrix.</p>
<p>I reported this to MathJud. He took some time to look at the dependency tree and figured out the exact conflicts. We were using <code>libp2p</code> at <code>0.50.x</code> and it had <code>libp2p-swarm-derive</code>. Now the <code>matrix-sdk</code> and <code>libp2p-swarm-derive</code> has two packages in common</p>
<ul>
<li>quote</li>
<li>syn</li>
</ul>
<p>And the <code>syn</code> package had a big version number change 1-&gt;2.
But If <code>libp2p</code> <code>0.52.0</code> gets released, It would have solved the conflict but it would require us to do some code changes to upgrade qaul to onboard <code>0.52.0</code> of libp2p. So, For inital rounds of test, We decided to stick with an older version of matrix-sdk with no change inside qaul.</p>
<p>I have although asked the maintainers of libp2p about when they'd plan their next release in one of their open issues : <a href="https://github.com/libp2p/rust-libp2p/issues/3647#issuecomment-1559944456">Link to discussion on <code>lib p2p 0.52.0</code> release</a></p>
<h2 id="sailing-the-boat"><a class="header" href="#sailing-the-boat">Sailing the Boat</a></h2>
<p>I have now started coding with <code>matrix-sdk 0.4.0</code> and implemented the very first feature which listens on the room for any messages on matrix and return us back with a simple message.</p>
<p>The <code>relay_bot::connect()</code> method were rightly used for login into matrix and listening on the matrix client for any activity or interact with it. Since this process required synchronus listening on the matrix service, It actually blocked the <code>qaul-cli</code>. We needed to run both the process simultaneously and synchronously.</p>
<ul>
<li>Keep checking for messages on matrix</li>
<li>Keep checking for messages in qaul</li>
</ul>
<p>To make both the calls on both side sync, We thought to run the process of matrix login and configuration inside a different thread. This way, the process kept running in new thread without blocking our qaul-cli. Another option was that we may have polled the matrix part inside the loop which runs in qaul for every 10 miliseconds for checking any command line events or RPC events. But, It comes with a problem of overhead since, <code>relay_bot::connect()</code> logs in every time we run in a loop and tweaking it was not likely the best option. Running in separate thread was the best thing which we got to see clearly.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>thread::spawn(|| {
        // connect the matrix bot with the qaul-cli
        match relay_bot::connect() {
            Ok(_) =&gt; {
                println!(&quot;Matrix-Bridge connecting&quot;);
            }
            Err(error) =&gt; {
                println!(&quot;{}&quot;, error);
            }
        }
    });
<span class="boring">}
</span></code></pre></pre>
<p>Next I have worked on developing the <code>!qaul</code> command and <code>!users-list</code> command which will listen to messages from matrix and respond from qaul with appropriate message.</p>
<p>Now that we know the using a !qaul command we are able to trigger a message from qaul broadcast, This ensures the in qaul we are able to listen successfully for all the messages comming from matrix room.</p>
<p>This is actually a simple implementation given by matrix-sdk itself. Here is the snippet below.</p>
<p>We first login to our bot client using the configuration which we have had in our matrix running thread. Then on that configuration, We listen for any incomming messages every few miliseconds (200ms for testing but should be less when it gets in real implementation).</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let client = Client::new_with_config(homeserver_url, client_config).unwrap();
    client
        .login(&amp;username, &amp;password, None, Some(&quot;command bot&quot;))
        .await?;
    println!(&quot;logged in as {}&quot;, username);

    // An initial sync to set up state and so our bot doesn't respond to old
    // messages.
    client.sync_once(SyncSettings::default()).await.unwrap();

    // Listening for all the incomming messages on bot account.
    client.register_event_handler(on_room_message).await;
<span class="boring">}
</span></code></pre></pre>
<p>and the magical implementation if any message is received is done in this function <code>on_room_message</code>.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>async fn on_room_message(event: SyncMessageEvent&lt;MessageEventContent&gt;, room: Room) {
    // If the room that receives the message is joined by the bot account.
    if let Room::Joined(room) = room {
        // Extract out the message content and name of sender.
        let (msg_body, msg_sender) = if let SyncMessageEvent {
            content:
                MessageEventContent {
                    msgtype: MessageType::Text(TextMessageEventContent { body: msg_body, .. }),
                    ..
                },
            sender: msg_sender,
            ..
        } = event
        {
            (msg_body, msg_sender)
        } else {
            return;
        };
        // If bot is replying then the same message in matrix room is considered as received and we 
        // get double copy of the sent message in qaul. So we don't listen for the messages where 
        // sender is qaul-bot.
        if msg_sender != &quot;@qaul-bot:matrix.org&quot; {
            let msg_text = format!(&quot;{} : {}&quot;, msg_sender, msg_body);

            // on receiving !qaul in matrix, Send message
            if msg_body.contains(&quot;!qaul&quot;) {
                let content = AnyMessageEventContent::RoomMessage(MessageEventContent::text_plain(
                    &quot;I am a message sent from qaul network\n&quot;,
                ));
                room.send(content, None).await.unwrap();
            }

            // on receiving !users-list in matrix, Send it to command line
            if msg_body.contains(&quot;!users-list&quot;) {
                let input_line = &quot;users list&quot;.to_string();
                let evt = Some(EventType::Cli(input_line));
                if let Some(event) = evt {
                    match event {
                        EventType::Cli(line) =&gt; {
                            Cli::process_command(line);
                        }
                    }
                }
            }
        } else {
            println!(&quot;Sent the message in the matrix room by !qaul-bot&quot;);
        }
    }
}
<span class="boring">}
</span></code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chapter_2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="chapter_4.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chapter_2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="chapter_4.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
